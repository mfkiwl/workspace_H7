## H750VBT6_FATFS_R015_SDMMC_TF_02

> 创建日期：2023-03-24

## 关于

用于 [H750VBT6_FATFS_R015_SDMMC_TF_01](https://github.com/oldgerman/workspace_H7/tree/master/H750VBT6_FATFS_R015_SDMMC_TF_01) 工程的下阶段测试

- 开发环境：STM32CubeIDE v1.11.2 + STM32CubeMX v6.6
- 包版本：STM32CubeH7 V1.11.0 / 04-Nov-2022
- 主RAM：DTCM
- FATFS：R0.15
- TF卡：FAT32 + 64KB 簇大小
- CPU利用率：由 TIM7 产生 20Ksps 中断作为高精度计数源

## 代码修改

### TileWave

- 函数整理到 .cpp
- 修复writeTileBuffer() 中计算平均频率的 BUG
- vTestMallocFree() 支持任意次数和初始大小的倍增动态内存申请释放，测试结果以 Markdown 表格输出

## 测试

### TileWave::vTestMallocFree()

测试命令：TW+TEST_DRAM=10+256

```c
【测试动态内存分配 10 次，起始大小 256 ，每次大小翻倍，单位byte】
【从DRAM申请空间】
| 已申请次数 | 内存池大小 |  申请大小  |  申请地址  |   共使用   |    剩余    | 历史最少可用 |
| ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ------------ |
|          1 |     131072 |        256 | 0x3000d088 |      53648 |      77424 |        12344 |
|          2 |     131072 |        512 | 0x3000d190 |      54168 |      76904 |        12344 |
|          3 |     131072 |       1024 | 0x3000d398 |      55200 |      75872 |        12344 |
|          4 |     131072 |       2048 | 0x3000d7a0 |      57256 |      73816 |        12344 |
|          5 |     131072 |       4096 | 0x3000dfa8 |      61360 |      69712 |        12344 |
|          6 |     131072 |       8192 | 0x3000efb0 |      69560 |      61512 |        12344 |
|          7 |     131072 |      16384 | 0x30010fb8 |      85952 |      45120 |        12344 |
|          8 |     131072 |      32768 | 0x30014fc0 |     118728 |      12344 |        12344 |
|          9 |     131072 |      65536 |          0 |     118728 |      12344 |        12344 |
|         10 |     131072 |     131072 |          0 |     118728 |      12344 |        12344 |

【释放从DRAM申请的空间】
|  释放次数  | 内存池大小 |  释放大小  |  释放地址  |   共使用   |    剩余    | 历史最少可用 |
| ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ------------ |
|          1 |     131072 |        256 | 0x3000d088 |     118464 |      12608 |        12344 |
|          2 |     131072 |        512 | 0x3000d190 |     117944 |      13128 |        12344 |
|          3 |     131072 |       1024 | 0x3000d398 |     116912 |      14160 |        12344 |
|          4 |     131072 |       2048 | 0x3000d7a0 |     114856 |      16216 |        12344 |
|          5 |     131072 |       4096 | 0x3000dfa8 |     110752 |      20320 |        12344 |
|          6 |     131072 |       8192 | 0x3000efb0 |     102552 |      28520 |        12344 |
|          7 |     131072 |      16384 | 0x30010fb8 |      86160 |      44912 |        12344 |
|          8 |     131072 |      32768 | 0x30014fc0 |      53384 |      77688 |        12344 |
|          9 |     131072 |      65536 |          0 |      53384 |      77688 |        12344 |
|         10 |     131072 |     131072 |          0 |      53384 |      77688 |        12344 |
```

